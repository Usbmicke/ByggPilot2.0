
version: '3.8'
services:
  next-app:
    build:
      context: .
      dockerfile: Dockerfile.next
    ports:
      - '3000:3000'
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      # Denna pekar Next.js-proxyn till Genkit-containern
      - GENKIT_API_HOST=http://genkit:4001 
      - FIRESTORE_EMULATOR_HOST=firebase-emulator:8080 # Port från emulatorn
      - FIREBASE_AUTH_EMULATOR_HOST=firebase-emulator:9099 # Port från emulatorn
      - GCLOUD_PROJECT=your-gcp-project-id 
    depends_on:
      - genkit
    command: npm run dev

  genkit:
    build:
      context: .
      dockerfile: Dockerfile.genkit
    ports:
      # Exponerar Genkit-serverns port för felsökning, men intern kommunikation sker via containernätverket
      - '4001:4001' 
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - FIRESTORE_EMULATOR_HOST=firebase-emulator:8080
      - FIREBASE_AUTH_EMULATOR_HOST=firebase-emulator:9099
      - GCLOUD_PROJECT=your-gcp-project-id
    depends_on:
      - firebase-emulator
    # Startar Genkit-servern och specificerar vilken port den ska lyssna på
    command: genkit start --port 4001

  firebase-emulator:
    image: firebase/tools:13.14.2
    ports:
      - '4000:4000' # Emulator Suite UI
      - '8080:8080' # Firestore Emulator
      - '9099:9099' # Auth Emulator
    volumes:
      - ./firebase-data:/app/firebase-data
    # Startar emulatorerna och gör dem tillgängliga för andra containrar
    command: >
      emulators:start 
      --only auth,firestore 
      --import /app/firebase-data 
      --export-on-exit /app/firebase-data
      --host 0.0.0.0

volumes:
  firebase-data:
