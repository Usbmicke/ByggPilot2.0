
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== ANVÄNDARE & KONTO (HÖGSTA SÄKERHET) =====
    // Denna regel är grunden för hela applikationens säkerhet.
    match /users/{userId} {
      
      // En användare får ENDAST läsa eller skriva sitt eget huvuddokument.
      allow read, write: if request.auth.uid == userId;

      // KORRIGERING: En användare får OCKSÅ hantera dokumenten i sin
      // egen "accounts" sub-collection. Detta är KRITISKT för att NextAuth
      // ska kunna spara tokens från Google och andra providers.
      match /accounts/{providerId} {
        allow read, write: if request.auth.uid == userId;
      }
    }

    // ===== SESSIONER (KRÄVS FÖR FIREBASEADAPTER) =====
    // Denna samling används internt av NextAuths FirestoreAdapter
    // för att hantera sessioner.
    match /sessions/{sessionId} {
    	allow read, write: if true; // Tillfälligt öppen, bör skärpas vid behov
    }

    // ===== PROJEKT, CHATTAR & MEDDELANDEN =====
    // Användare kan bara komma åt dokument som har deras eget userId.
    match /projects/{projectId} {
      allow read, write: if request.auth.uid == resource.data.userId;
    }
    
    match /chats/{chatId} {
    	allow read, write: if request.auth.uid == resource.data.userId;
    }
    
    match /messages/{messageId} {
    	allow read, write: if request.auth.uid == resource.data.userId;
    }
  }
}
