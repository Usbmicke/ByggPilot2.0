import { defineFlow, runFlow } from \'@genkit-ai/flow\';\nimport { z } from \'zod\';\nimport { firebaseAuth } from \'@genkit-ai/firebase/auth\';\nimport { createUserProfile, getUserById } from \'../../lib/dal/repositories/user.repo\';\n\n// This is the main authentication flow. When called from the frontend with a valid\n// Firebase ID token, Genkit\'s `firebaseAuth` policy will automatically validate it\n// and create a secure, HttpOnly session cookie, which is then used for all\n// subsequent requests to protected flows.\nexport const userSessionLogin = defineFlow({\n  name: \'userSessionLogin\',\n  inputSchema: z.object({}), // No input needed, token is in the header\n  authPolicy: firebaseAuth(async (user) => {\n    // This block runs AFTER the token is successfully verified.\n    // Here, we can add logic like creating a user profile on first login.\n    const existingUser = await getUserById(user.uid);\n\n    if (!existingUser) {\n      console.log(`First time login for user ${user.uid}, creating profile.`);\n      await runFlow(createUserProfileFlow, { \n        uid: user.uid, \n        email: user.email!, \n        name: user.name, \n        avatarUrl: user.picture \n      });\n    }\n  }),\n}, async () => {\n  // If we get here, the token was valid and the session cookie is set.\n  return { success: true, message: \"Session cookie created successfully.\" };\n});\n\n// A separate flow for creating a user profile to keep logic clean.\nconst createUserProfileFlow = defineFlow({\n  name: \'createUserProfileFlow\',\n  inputSchema: z.object({\n    uid: z.string(),\n    email: z.string(),\n    name: z.string().optional(),\n    avatarUrl: z.string().url().optional(),\n  }),\n}, async (profileData) => {\n  return await createUserProfile(profileData);\n});\n\n/**\n * ðŸ”¥ [NEW] Onboarding Flow to create Google Drive structure. ðŸ”¥\n * This flow is called from the client-side after the user logs in\n * and clicks the \"Create Structure\" button on the onboarding page.\n */\nexport const onboardingFlow = defineFlow({\n  name: \'onboardingFlow\',\n  // The client sends a payload like { companyName: \'...\' }\n  inputSchema: z.object({\n    companyName: z.string(),\n  }),\n  // This endpoint is protected. The `firebaseAuth` policy validates the\n  // user\'s ID token from the `Authorization` header.\n  authPolicy: firebaseAuth(async (user) => {}),\n}, async (payload) => {\n  try {\n    // Log receipt of the request, including the authenticated user\'s UID\n    console.log(`[onboardingFlow] Received request for company: \\\"${payload.companyName}\\\"\`);\n\n    // TODO: Implement the actual Google Drive folder creation logic here.\n    // This will involve using the Google Drive API, likely with user credentials\n    // or a service account. For now, we simulate a successful operation.\n\n    const simulatedRootFolderId = \'1a2b3c-simulated-folder-id-xyz\';\n\n    console.log(`[onboardingFlow] Simulated Google Drive structure creation was successful.`);\n\n    // Return a valid JSON response indicating success.\n    return {\n      success: true,\n      message: `Successfully created folder structure for ${payload.companyName}.`,\n      rootFolderId: simulatedRootFolderId,\n    };\n  } catch (error) {\n    console.error(\'[onboardingFlow] An error occurred while creating the Google Drive structure:\', error);\n    \n    // IMPORTANT: Always return a valid JSON object, even in case of an error.\n    // This prevents the frontend from crashing.\n    return {\n      success: false,\n      message: \'An unexpected error occurred on the server.\',\n      error: error instanceof Error ? error.message : String(error),\n    };\n  }\n});\n